/**
 * jQuery Reference Parser
 *
 * jQuery Reference Parser is a jQuery, javascript front-end to a JSON-producing, bibliographic citation parser.
 * 
 * Version 2.1
 * November 14, 2010
 *
 * Copyright (c) 2010 David P. Shorthouse
 * Licensed under the MIT license.
 * http://creativecommons.org/licenses/MIT/
 **/
/*global $, jQuery, encodeURIComponent, Right */
(function(a){"use strict",a.fn.refparser=function(b){var c=this,d={parserUrl:"http://biblio.globalnames.org/parser.json",target:"",sources:["crossref","bhl","biostor"],style:"apa",timeout:1e4,iconPath:"http://biblio.globalnames.org/assets/",iconClass:"refparser-icon",icons:{search:{title:"Search",icon:"magnifier.png"},loader:{title:"Loooking for reference...",icon:"ajax-loader.gif"},doi:{title:"To publisher...",icon:"world_go.png"},bhl:{title:"Biodiversity Heritage Library...",icon:"page_white_go.png"},biostor:{title:"BioStor...",icon:"page_white_go.png"},scholar:{title:"Search Google Scholar...",icon:"g_scholar.png"},timeout:{title:"Timeout",icon:"clock_red.png"},error:{title:"Failed parse or DOI look-up",icon:"error.png"}},onSuccessfulParse:function(a,b){a=null,b=null},onFailedParse:function(a){a=null},onError:function(a){a=null}},e=["ama","apa","asa"],f=a.extend({},d,b);return c.execute=function(b,c){var d=b.find("."+f.iconClass),g="",h="",i="",j="",k=f.target||"",l=f.timeout<=1e4?f.timeout:1e4,m=a.inArray(f.style,e)>0?f.style:"apa";a.each(f.sources,function(){j+="&amp;sources["+this+"]=true"}),d.unbind("click").find("img").attr({src:f.iconPath+f.icons.loader.icon,alt:f.icons.loader.title,title:f.icons.loader.title}),a.ajax({type:"GET",dataType:"jsonp",url:f.parserUrl+"?q="+encodeURIComponent(c)+j+"&amp;style="+m+"&amp;callback=?",timeout:l,success:function(e){g=e.records[0].identifiers||"",h=e.records[0].title||"",i=e.records[0].formatted||"",h?(g.length===0&&h?d.attr({href:"http://scholar.google.com/scholar?q="+encodeURIComponent(h),target:k}).find("img").attr({src:f.iconPath+f.icons.scholar.icon,alt:f.icons.scholar.title,title:f.icons.scholar.title}):a.each(g,function(a,e){return a=null,e.type==="doi"?(d.attr({href:"http://dx.doi.org/"+e.id,target:k}).find("img").attr({src:f.iconPath+f.icons.doi.icon,alt:f.icons.doi.title,title:f.icons.doi.title}),c.match(/10\.(\d)+(\S)+/)&&b.find(":first").is(':input[type="text"]')&&b.find(":first").val(i)):e.type==="bhl"?d.attr({href:e.id,target:k}).find("img").attr({src:f.iconPath+f.icons.bhl.icon,alt:f.icons.bhl.title,title:f.icons.bhl.title}):e.type==="biostor"&&d.attr({href:e.id,target:k}).find("img").attr({src:f.iconPath+f.icons.biostor.icon,alt:f.icons.biostor.title,title:f.icons.biostor.title}),!1}),f.onSuccessfulParse.call(this,b,e)):(d.click(function(){return!1}).find("img").attr({src:f.iconPath+f.icons.error.icon,alt:f.icons.error.title,title:f.icons.error.title}),f.onFailedParse.call(this,b))},error:function(){d.click(function(){return!1}).find("img").attr({src:f.iconPath+f.icons.timeout.icon,alt:f.icons.timeout.title,title:f.icons.timeout.title}),f.onError.call(this,b)}})},this.each(function(){var b=a(this);b.is(':input[type="text"]')?b.wrap("<div />").live("blur",function(){b.parent().find("."+f.iconClass).remove(),b.val()!==""&&(b.parent().append('<a href="#" class="'+f.iconClass+'"><img src="'+f.iconPath+f.icons.loader.icon+'" alt="'+f.icons.loader.title+'" title="'+f.icons.loader.title+'" /></a>').find("."+f.iconClass).click(function(){return!1}),c.execute(b.parent(),b.val()))}).live("keypress",function(a){var b=a.keyCode||a.which;if(b===13||b===9)a.preventDefault(),this.blur()}):(b.append('<a href="#" class="'+f.iconClass+'"><img src="'+f.iconPath+f.icons.search.icon+'" alt="'+f.icons.search.title+'" title="'+f.icons.search.title+'" /></a>'),b.find("."+f.iconClass).click(function(){return c.execute(b,b.text()),!1}).end().find("img").css({border:"0px"}))})}})(jQuery);